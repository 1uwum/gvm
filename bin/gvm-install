#!/bin/bash
function check_existing() {
  if [ -e "$1" ]; then
    if [ -e "$1/success.gvm" ]; then
      echo "Already installed!"
      exit 0
    else
      echo "Already installed but not verified"
      exit 0
    fi
  fi
}

mkdir -p $GVM_ROOT/gos > /dev/null 2>&1
if [[ $1 == "install" ]]; then
  if [[ -n $2 ]]; then
    curl -s https://go.googlecode.com/hg/.hgtags | awk '{print $2;}' | grep "$2" > /dev/null 2>&1
    if [[ $? == 0 ]]; then
      REVISION=`curl -s https://go.googlecode.com/hg/.hgtags | awk '{print $2;}' | grep "$2" | tail -n 1`
      INSTALL_ROOT=$GVM_ROOT/gos/$REVISION
      check_existing $INSTALL_ROOT
      echo "Installing version $REVISION"
      echo " * Downloading..."
      hg clone -u $REVISION https://go.googlecode.com/hg/ $INSTALL_ROOT > $GVM_ROOT/download.log 2>&1
      if [[ $? == 0 ]]; then
        echo " * Compiling..."
      else
        echo "Failed to download version $REVISION. See logs in $GVM_ROOT/download.log for details"
        exit 1
      fi
      cd $INSTALL_ROOT/src && 
        unset GOROOT &&
        unset GOARCH &&
        unset GOOS &&
        unset GOPATH &&
        export GOROOT=$INSTALL_ROOT &&
        echo "Running install with GOROOT ($GOROOT)"  &&
        echo "ENV =====" &&
	env | grep ^GO &&
	echo "END ENV ====" &&
         ./all.bash > $INSTALL_ROOT/install.log 2>&1

      if [[ $? == 0 ]]; then
        mkdir -p $GVM_ROOT/pkgsets/$REVISION/default
        exit 0
      else
        echo "Failed to install version $REVISION. See logs in $INSTALL_ROOT/install.log for details"
        exit 1
      fi
			touch $INSTALL_ROOT/sucess.gvm
    else
      echo "ERROR: Unknown go release version: '$2'"
    fi
  else
    echo "ERROR: Please specifiy the version"
    exit 1
  fi
else
  echo "Please use gvm [action] to call this file"
  exit 1
fi

